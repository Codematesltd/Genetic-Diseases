{% extends "base.html" %}

{% block title %}Risk Prediction{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-800 mb-4">Genetic Disease Risk Prediction</h1>
        <p class="text-xl text-gray-600">Enter your clinical and genetic parameters to assess potential risks</p>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="mb-4 p-4 rounded-md {{ 'bg-red-100 text-red-700' if category == 'error' else 'bg-green-100 text-green-700' }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Main Content -->
    <div class="grid md:grid-cols-2 gap-8">
        <!-- Prediction Form -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <form method="POST" class="space-y-6" id="predictionForm">
                <div>
                    <label for="age" class="block text-sm font-medium text-gray-700">Age</label>
                    <input type="number" name="age" id="age" required min="0" max="120" step="1"
                        value="{{ form_data.age if form_data }}"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="gender" class="block text-sm font-medium text-gray-700">Gender</label>
                    <select name="gender" id="gender" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="1" {{ 'selected' if form_data and form_data.gender == 1 }}>Male</option>
                        <option value="0" {{ 'selected' if form_data and form_data.gender == 0 }}>Female</option>
                    </select>
                </div>
                <div>
                    <label for="family_history" class="block text-sm font-medium text-gray-700">Family History</label>
                    <select name="family_history" id="family_history" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="1" {{ 'selected' if form_data and form_data.family_history == 1 }}>Yes</option>
                        <option value="0" {{ 'selected' if form_data and form_data.family_history == 0 }}>No</option>
                    </select>
                </div>
                <div>
                    <label for="hemoglobin" class="block text-sm font-medium text-gray-700">Hemoglobin</label>
                    <input type="number" name="hemoglobin" id="hemoglobin" required step="0.01"
                        value="{{ form_data.hemoglobin if form_data }}"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="fetal_hemoglobin" class="block text-sm font-medium text-gray-700">Fetal Hemoglobin</label>
                    <input type="number" name="fetal_hemoglobin" id="fetal_hemoglobin" required step="0.01"
                        value="{{ form_data.fetal_hemoglobin if form_data }}"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="rdw_cv" class="block text-sm font-medium text-gray-700">RDW_CV</label>
                    <input type="number" name="rdw_cv" id="rdw_cv" required step="0.01"
                        value="{{ form_data.rdw_cv if form_data }}"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="serum_ferritin" class="block text-sm font-medium text-gray-700">Serum Ferritin</label>
                    <input type="number" name="serum_ferritin" id="serum_ferritin" required step="0.01"
                        value="{{ form_data.serum_ferritin if form_data }}"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="brca1_expression" class="block text-sm font-medium text-gray-700">BRCA1 Expression</label>
                    <input type="number" name="brca1_expression" id="brca1_expression" required step="0.01"
                        value="{{ form_data.brca1_expression if form_data }}"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="p53_mutation" class="block text-sm font-medium text-gray-700">p53 Mutation</label>
                    <select name="p53_mutation" id="p53_mutation" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="1" {{ 'selected' if form_data and form_data.p53_mutation == 1 }}>Yes</option>
                        <option value="0" {{ 'selected' if form_data and form_data.p53_mutation == 0 }}>No</option>
                    </select>
                </div>
                <div>
                    <label for="sweat_chloride" class="block text-sm font-medium text-gray-700">Sweat Chloride</label>
                    <input type="number" name="sweat_chloride" id="sweat_chloride" required step="0.01"
                        value="{{ form_data.sweat_chloride if form_data }}"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="sickled_rbc_percent" class="block text-sm font-medium text-gray-700">Sickled RBC Percent</label>
                    <input type="number" name="sickled_rbc_percent" id="sickled_rbc_percent" required step="0.01"
                        value="{{ form_data.sickled_rbc_percent if form_data }}"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="il6_level" class="block text-sm font-medium text-gray-700">IL6 Level</label>
                    <input type="number" name="il6_level" id="il6_level" required step="0.01"
                        value="{{ form_data.il6_level if form_data }}"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <button type="submit"
                    class="w-full py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Calculate Risk
                </button>
            </form>
        </div>

        <!-- Results Section -->
        <div>
            {% if result %}
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Prediction Results</h2>
                <div class="mb-4">
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Predicted Disease</h3>
                    <div class="text-xl font-semibold text-blue-700 mb-2">
                        {{ disease_labels[prediction] if disease_labels and prediction is not none }}
                    </div>
                </div>
                
                <!-- Risk Level -->
                <div class="mb-6">
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Risk Level</h3>
                    <div class="text-3xl font-bold mb-2 {{ 'text-green-600' if not prediction else 'text-red-600' }}">
                        {{ 'Low Risk' if not prediction else 'High Risk' }}
                    </div>
                    <div class="text-gray-600">
                        Confidence: {{ "%.1f"|format(probability * 100) }}%
                    </div>
                </div>

                <!-- Recommendations -->
                <div>
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Recommendations</h3>
                    <ul class="list-disc list-inside text-gray-600 space-y-2">
                        {% if prediction %}
                        <li>Consider genetic counseling for more detailed assessment</li>
                        <li>Regular health check-ups recommended</li>
                        <li>Monitor blood pressure and cholesterol levels</li>
                        <li>Discuss preventive measures with your healthcare provider</li>
                        {% else %}
                        <li>Continue maintaining a healthy lifestyle</li>
                        <li>Regular health check-ups as recommended by your doctor</li>
                        <li>Stay informed about your family health history</li>
                        {% endif %}
                    </ul>
                </div>
            </div>
            {% else %}
            <div class="bg-gray-50 rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">How It Works</h2>
                <p class="text-gray-600 mb-4">
                    Our AI-powered prediction model analyzes various factors to assess your potential risk for genetic diseases:
                </p>
                <ul class="list-disc list-inside text-gray-600 space-y-2">
                    <li>Age and general health parameters</li>
                    <li>Clinical markers like cholesterol and blood pressure</li>
                    <li>Genetic risk scores from DNA testing</li>
                    <li>Family history of genetic conditions</li>
                </ul>
                <div class="mt-6">
                    <p class="text-sm text-gray-500">
                        Note: This tool provides an initial risk assessment and should not be used as a substitute for 
                        professional medical advice. Always consult with healthcare providers for proper diagnosis and treatment.
                    </p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Disclaimer -->
    <div class="mt-8 text-center text-sm text-gray-500">
        <p>This prediction tool is for informational purposes only and should not be considered as medical advice.</p>
        <p>Always consult with healthcare professionals for proper diagnosis and treatment.</p>
    </div>
</div>

<!-- Form Validation -->
<script>
document.getElementById('predictionForm').addEventListener('submit', function(e) {
    const age = document.getElementById('age').value;
    const cholesterol = document.getElementById('cholesterol').value;
    const bloodPressure = document.getElementById('blood_pressure').value;
    const geneticScore = document.getElementById('genetic_risk_score').value;
    
    let isValid = true;
    let message = '';
    
    if (age < 0 || age > 120) {
        message = 'Please enter a valid age between 0 and 120.';
        isValid = false;
    }
    else if (cholesterol < 100 || cholesterol > 500) {
        message = 'Please enter a valid cholesterol level between 100 and 500 mg/dL.';
        isValid = false;
    }
    else if (bloodPressure < 70 || bloodPressure > 250) {
        message = 'Please enter a valid systolic blood pressure between 70 and 250.';
        isValid = false;
    }
    else if (geneticScore < 0 || geneticScore > 100) {
        message = 'Please enter a valid genetic risk score between 0 and 100.';
        isValid = false;
    }
    
    if (!isValid) {
        e.preventDefault();
        alert(message);
    }
});
</script>
{% endblock %}